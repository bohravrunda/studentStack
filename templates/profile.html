<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StudentStack Profile</title>
  <link rel="stylesheet" href="/static/styles/profile.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<!-- Navbar -->
<nav>
  <div class="logo">
    <img src="/static/images/logo.jpg" class="logo-img" alt="Logo">
    <span>StudentStack</span>
  </div>
  <div class="search-container">
    <input type="text" class="search-input" placeholder="Search services..." />
    <button class="search-button"><i class="fas fa-search"></i></button>
  </div>
  <div class="moving-text">
    <marquee behavior="scroll" direction="left" scrollamount="4">
      Exchange Skills, Expand Possibilities. Trade Knowledge, not just tools.
    </marquee>
  </div>
  <div class="nav-buttons">
    <a href="cart.html" class="cart-icon"><i class="fas fa-shopping-cart"></i></a>
    <div class="menu-icon" style="color: white; font-size: 30px; cursor: pointer;">&#9776;</div>
  </div>
</nav>



<!-- Drawer -->
<div id="right-drawer" class="drawer">
  <ul>
    <li id="avatar-item" style="display:none;">
      <div id="user-avatar" class="user-avatar">RS</div>
    </li>
    <li><i class="fas fa-user"></i><a href="profile.html">Profile</a></li>
    <li><i class="fas fa-eye"></i><a href="view.html">View Services</a></li>
    <li><i class="fas fa-plus-circle"></i><a href="createService.html">Create Service</a></li>
    <li><i class="fas fa-briefcase"></i><a href="createdservices.html">My Services</a></li>
    <li><i class="fas fa-book"></i><a href="bookedServices.html">My Bookings</a></li>
    <li id="logout-item" style="color: red; font-weight: bold; display: none; cursor: pointer;">
      <i class="fas fa-sign-out-alt"></i><span id="logout-link">Logout</span>
    </li>
  </ul>
</div>

<!-- Overlay -->
<div id="overlay" class="overlay"></div>






<!-- Sidebar + Main -->
<div id="sidebar" class="sidebar">
  <div class="sidebar-header">
    <img src="/static/images/avatar.jpg" alt="Avatar" class="avatar" />
    <h3 id="sidebar-name">John Doe</h3>
  </div>
  <ul class="sidebar-menu">
    <li><i class="fas fa-user"></i> Profile</li>
    <li><i class="fas fa-eye"></i> View Services</li>
    <li><i class="fas fa-plus-circle"></i> Create Service</li>
    <li><i class="fas fa-briefcase"></i> My Services</li>
    <li><i class="fas fa-book"></i> My Bookings</li>
    <li><i class="fas fa-sign-out-alt"></i> Logout</li>
  </ul>
</div>

<div class="container">
  <div class="main-content">
    <div class="header">
      <h2 id="welcome-message">Welcome, </h2>
    </div>

    <div class="profile-card">
      <div class="top-section">
        <div class="profile-image">
          <label for="pic-input" class="upload-label">
            <div id="initial-avatar" class="initial-avatar">A</div>
            <img id="preview" style="display: none;" alt="Profile Pic" />
            <div class="upload-hint">Click to upload</div>
          </label>
          <input type="file" id="pic-input" onchange="previewPic(event)" style="display: none;" />
        </div>

        <div>
          <h3 id="profile-name">Alexa Rawles</h3>
          <p id="profile-email">alexarawles@gmail.com</p>
        </div>
        <button class="edit-btn">Save</button>
      </div>

      <div class="form-grid">
        <div class="form-group"><label>First Name *</label><input type="text" id="first-name" /></div>
        <div class="form-group"><label>Last Name *</label><input type="text" id="last-name" /></div>
        <div class="form-group"><label>Username *</label><input type="text" id="username" /></div>
        <div class="form-group"><label>College Name *</label><input type="text" id="college-name" /></div>
        <div class="form-group"><label>Department *</label><input type="text" id="department" /></div>
        <div class="form-group"><label>Semester *</label><input type="text" id="semester" /></div>
        <div class="form-group"><label>Gender *</label><select id="gender"><option>Select</option><option>Male</option><option>Female</option><option>Other</option></select></div>
        <div class="form-group"><label>Country *</label><input type="text" id="country" /></div>
        <div class="form-group"><label>Language *</label><select id="language"><option>Select</option><option>English</option><option>Hindi</option></select></div>
        <div class="form-group" style="grid-column: span 2;"><label>Bio *</label><textarea id="bio"></textarea></div>
      </div>

      <div class="email-section">
        <p class="email-title">My Email Address</p>
        <div class="email-box">
          <img src="https://cdn-icons-png.flaticon.com/512/732/732200.png" />
          <div><p id="email-display">alexarawles@gmail.com</p><small>1 month ago</small></div>
        </div>
        <button class="add-email" onclick="showEmailInput()">+ Add Email Address</button>
        <div id="new-email-section" style="display:none;">
          <input type="email" id="new-email" placeholder="Enter new email" />
          <button onclick="saveNewEmail()">Save</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- About Section -->
<section class="about-section">
  <div class="about-container">
    <h2>About StudentStack</h2>
    <p>
      StudentStack is your one-stop platform to share skills, discover services, and connect with a vibrant student community. 
      Whether you want to showcase your talent or explore new opportunities — we’ve got you covered.
    </p>
    <div class="social-links">
      <a href="#" target="_blank"><i class="fab fa-instagram"></i></a>
      <a href="#" target="_blank"><i class="fab fa-linkedin"></i></a>
      <a href="#" target="_blank"><i class="fab fa-twitter"></i></a>
    </div>
  </div>
</section>
<div id="snackbar">Profile saved successfully</div>


<script>

document.querySelector(".menu-icon").addEventListener("click", function () {
  document.getElementById("right-drawer").classList.add("open");
  document.getElementById("overlay").classList.add("active");
});

document.getElementById("overlay").addEventListener("click", function () {
  document.getElementById("right-drawer").classList.remove("open");
  document.getElementById("overlay").classList.remove("active");
});


  window.addEventListener('DOMContentLoaded', async () => {
    try {
      const res = await fetch("http://localhost:5000/me", { credentials: "include" });
      if (res.ok) {
        const user = await res.json();
        const username = user.username || "User";
        localStorage.setItem('username', username);
        localStorage.setItem('userId', user.userId);
        const initials = username.trim().split(" ").map(word => word[0].toUpperCase()).join("");
        document.getElementById('user-avatar').textContent = initials;
        document.getElementById('avatar-item').style.display = 'block';
        document.getElementById('logout-item').style.display = 'block';
      }
    } catch (err) {
      console.error("Error checking login status:", err);
    }

    updateCartCount();
  });



let isEditing = true;

async function previewPic(event) {
  const file = event.target.files[0];
  if (file) {
    const formData = new FormData();
    formData.append("profile_pic", file);

    try {
      const res = await fetch('/upload-profile-pic', {
        method: 'POST',
        body: formData
      });

      const data = await res.json();
      if (data.profilePicUrl) {
        const preview = document.getElementById('preview');
        const initialAvatar = document.getElementById('initial-avatar');
        preview.src = data.profilePicUrl;
        preview.style.display = 'block';
        initialAvatar.style.display = 'none';
      } else {
        alert("Failed to upload image.");
      }
    } catch (err) {
      alert("Upload Error: " + err.message);
    }
  }
}

function setReadOnlyState(readonly = true) {
  const inputs = document.querySelectorAll('.form-group input, .form-group textarea');
  const selects = document.querySelectorAll('.form-group select');
  inputs.forEach(input => input.readOnly = readonly);
  selects.forEach(select => select.disabled = readonly);
}

function showEmailInput() {
  document.getElementById("new-email-section").style.display = "block";
}

function saveNewEmail() {
  const email = document.getElementById("new-email").value.trim();
  if (email) {
    document.getElementById("email-display").textContent = email;
    document.getElementById("profile-email").textContent = email;
    document.getElementById("new-email-section").style.display = "none";
    document.getElementById("new-email").value = '';
  }
}

function updateWelcomeMessage() {
  const firstNameInput = document.getElementById("first-name");
  const lastNameInput = document.getElementById("last-name");

  const update = () => {
    const first = firstNameInput.value.trim();
    const last = lastNameInput.value.trim();
    const fullName = `${first} ${last}`.trim();
    document.getElementById("welcome-message").textContent = fullName ? `Welcome, ${fullName}` : 'Welcome, Guest';
    document.getElementById("profile-name").textContent = fullName;
    document.getElementById("sidebar-name").textContent = fullName;
  };

  firstNameInput.addEventListener("input", update);
  lastNameInput.addEventListener("input", update);
}

async function saveProfileToServer() {
  const profileData = {
    firstName: document.getElementById("first-name").value,
    lastName: document.getElementById("last-name").value,
    username: document.getElementById("username").value,
    collegeName: document.getElementById("college-name").value,
    department: document.getElementById("department").value,
    semester: document.getElementById("semester").value,
    gender: document.getElementById("gender").value,
    country: document.getElementById("country").value,
    language: document.getElementById("language").value,
    bio: document.getElementById("bio").value,
    email: document.getElementById("email-display").textContent,
    profilePicUrl: document.getElementById("preview").src || ""
  };

  try {
    const res = await fetch(`/get-profile?userId=${profileData.email}`);
if (res.status === 404) {
  const saveRes = await fetch('/save-profile', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(profileData)
  });
  const result = await saveRes.json();
  showSnackbar(result.message || "Profile saved successfully");
} else {
  const editRes = await fetch('/edit-profile', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(profileData)
  });
  const result = await editRes.json();
  showSnackbar(result.message || "Profile updated successfully");
}

  } catch (err) {
    alert("Error: " + err.message);
  }
}

document.querySelector(".edit-btn").addEventListener("click", async function () {
  if (isEditing) {
    await saveProfileToServer();
    setReadOnlyState(true);
    this.textContent = "Edit";
  } else {
    setReadOnlyState(false);
    this.textContent = "Save";
  }
  isEditing = !isEditing;
});

window.onload = async () => {
  try {
    const res = await fetch('/session-user');
    if (res.ok) {
      const user = await res.json();
      const email = user.email || "guest@example.com";
      const name = user.username || "Guest";

      document.getElementById("profile-email").textContent = email;
      document.getElementById("email-display").textContent = email;
      document.getElementById("initial-avatar").textContent = email.charAt(0).toUpperCase();

      const profileRes = await fetch(`/get-profile?userId=${email}`);
      if (profileRes.ok) {
        const data = await profileRes.json();

        document.getElementById("first-name").value = data.firstName || "";
        document.getElementById("last-name").value = data.lastName || "";
        document.getElementById("username").value = data.username || "";
        document.getElementById("college-name").value = data.collegeName || "";
        document.getElementById("department").value = data.department || "";
        document.getElementById("semester").value = data.semester || "";
        document.getElementById("gender").value = data.gender || "Select";
        document.getElementById("country").value = data.country || "";
        document.getElementById("language").value = data.language || "Select";
        document.getElementById("bio").value = data.bio || "";

        const fullName = `${data.firstName || ""} ${data.lastName || ""}`.trim();
        document.getElementById("welcome-message").textContent = fullName ? `Welcome, ${fullName}` : `Welcome, ${name}`;
        document.getElementById("profile-name").textContent = fullName;
        document.getElementById("sidebar-name").textContent = fullName;

        if (data.profilePicUrl) {
          document.getElementById("preview").src = data.profilePicUrl;
          document.getElementById("preview").style.display = 'block';
          document.getElementById("initial-avatar").style.display = 'none';
        }
      }
    } else {
      window.location.href = "/login";
    }
  } catch (err) {
    console.error("Session Load Error:", err);
  }

  setReadOnlyState(false);
  updateWelcomeMessage();
  document.querySelector(".edit-btn").textContent = "Save";
  isEditing = true;
};
function showSnackbar(message) {
  const snackbar = document.getElementById("snackbar");
  snackbar.textContent = message;
  snackbar.classList.add("show");
  setTimeout(() => {
    snackbar.classList.remove("show");
  }, 3000);
}

</script>

</body>
</html>
