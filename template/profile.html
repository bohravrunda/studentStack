<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StudentStack Profile</title>
  <link rel="stylesheet" href="../styles/profile.css" />
  <style>
    input:read-only,
    textarea:read-only,
    select:disabled {
      background-color: #f2f2f2;
      border: 1px solid #ccc;
    }
    .form-group label span {
      color: red;
    }

    .profile-image {
      position: relative;
      width: 120px;
      height: 120px;
      cursor: pointer;
      margin-right: 20px;
    }

    .upload-label {
      width: 100%;
      height: 100%;
      display: block;
      position: relative;
      cursor: pointer;
    }

    .initial-avatar, #preview {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background-color: #4CAF50;
      color: white;
      font-size: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      object-fit: cover;
      transition: opacity 0.3s ease;
    }

    .upload-hint {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 6px 0;
      text-align: center;
      font-size: 12px;
      background-color: rgba(0,0,0,0.6);
      color: #fff;
      opacity: 0;
      border-radius: 0 0 50% 50%;
      transition: opacity 0.3s ease;
    }

    .upload-label:hover .upload-hint {
      opacity: 1;
    }
  </style>
</head>
<body>

  <nav>
    <div class="logo">
      <img src="../images/logo.jpg" class="logo-img">
      <span>StudentStack</span>
    </div>
    <div class="nav-buttons">
      <button id="login-btn">Login</button>
      <button id="signup-btn" class="signup-btn">Sign Up</button>
      <div class="menu-icon">&#9776;</div>
    </div>
  </nav>

  <div id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <img src="../images/avatar.jpg" alt="Avatar" class="avatar" />
      <h3 id="sidebar-name">John Doe</h3>
    </div>
    <ul class="sidebar-menu">
      <li><i class="fas fa-user"></i> Profile</li>
      <li><i class="fas fa-eye"></i> View Services</li>
      <li><i class="fas fa-plus-circle"></i> Create Service</li>
      <li><i class="fas fa-briefcase"></i> My Services</li>
      <li><i class="fas fa-book"></i> My Bookings</li>
      <li><i class="fas fa-sign-out-alt"></i> Logout</li>
    </ul>
  </div>

  <div class="container">
    <div class="sidebar"></div>

    <div class="main-content">
      <div class="header">
        <h2 id="welcome-message">Welcome, </h2>
        <div class="search-area">
          <input type="text" placeholder="Search..." />
        </div>
      </div>

      <div class="profile-card">
        <div class="top-section">
          <div class="profile-image">
            <label for="pic-input" class="upload-label">
              <div id="initial-avatar" class="initial-avatar">A</div>
              <img id="preview" style="display: none;" alt="Profile Pic" />
              <div class="upload-hint">Click to upload</div>
            </label>
            <input type="file" id="pic-input" onchange="previewPic(event)" style="display: none;" />
          </div>

          <div>
            <h3 id="profile-name">Alexa Rawles</h3>
            <p id="profile-email">alexarawles@gmail.com</p>
          </div>
          <button class="edit-btn">Save</button>
        </div>

        <div class="form-grid">
          <div class="form-group"><label>Full Name <span>*</span></label><input type="text" id="full-name" placeholder="Your Full Name" /></div>
          <div class="form-group"><label>Username <span>*</span></label><input type="text" id="username" placeholder="Username or Handle" /></div>
          <div class="form-group"><label>College Name <span>*</span></label><input type="text" id="college-name" placeholder="College Name" /></div>
          <div class="form-group"><label>Department <span>*</span></label><input type="text" id="department" placeholder="Department" /></div>
          <div class="form-group"><label>Semester <span>*</span></label><input type="text" id="semester" placeholder="Semester / Year" /></div>
          <div class="form-group"><label>Gender <span>*</span></label><select id="gender"><option>Select</option><option>Male</option><option>Female</option><option>Other</option></select></div>
          <div class="form-group"><label>Country <span>*</span></label><input type="text" id="country" placeholder="Country" /></div>
          <div class="form-group"><label>Language <span>*</span></label><select id="language"><option>Select</option><option>English</option><option>Hindi</option></select></div>
          <div class="form-group" style="grid-column: span 2;"><label>Bio / Description <span>*</span></label><textarea id="bio" placeholder="Short bio or description about yourself"></textarea></div>
        </div>

        <div class="email-section">
          <p class="email-title">My Email Address</p>
          <div class="email-box">
            <img src="https://cdn-icons-png.flaticon.com/512/732/732200.png" />
            <div><p id="email-display">alexarawles@gmail.com</p><small>1 month ago</small></div>
          </div>
          <button class="add-email" onclick="showEmailInput()">+ Add Email Address</button>
          <div id="new-email-section" style="display:none; margin-top: 10px;">
            <input type="email" id="new-email" placeholder="Enter new email" />
            <button onclick="saveNewEmail()">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  let isEditing = true;

  function previewPic(event) {
    const file = event.target.files[0];
    if (file) {
      const preview = document.getElementById('preview');
      const initialAvatar = document.getElementById('initial-avatar');
      preview.src = URL.createObjectURL(file);
      preview.style.display = 'block';
      initialAvatar.style.display = 'none';
    }
  }

  function setReadOnlyState(readonly = true) {
    const inputs = document.querySelectorAll('.form-group input, .form-group textarea');
    const selects = document.querySelectorAll('.form-group select');
    inputs.forEach(input => input.readOnly = readonly);
    selects.forEach(select => select.disabled = readonly);
  }

  function showEmailInput() {
    document.getElementById("new-email-section").style.display = "block";
  }

  function saveNewEmail() {
    const email = document.getElementById("new-email").value.trim();
    if (email) {
      document.getElementById("email-display").textContent = email;
      document.getElementById("profile-email").textContent = email;
      document.getElementById("new-email-section").style.display = "none";
      document.getElementById("new-email").value = '';
    }
  }

  function updateWelcomeMessage() {
    const fullNameInput = document.getElementById("full-name");
    const welcomeMessage = document.getElementById("welcome-message");
    fullNameInput.addEventListener("input", () => {
      const name = fullNameInput.value.trim();
      welcomeMessage.textContent = name ? `Welcome, ${name}` : 'Welcome, Guest';
      document.getElementById("profile-name").textContent = name;
      document.getElementById("sidebar-name").textContent = name;
    });
  }

async function saveProfileToServer() {
  const userId = localStorage.getItem("userId") || "demoUser123";
  const fullName = document.getElementById("full-name").value;
  const username = document.getElementById("username").value;
  const collegeName = document.getElementById("college-name").value;
  const department = document.getElementById("department").value;
  const semester = document.getElementById("semester").value;
  const gender = document.getElementById("gender").value;
  const country = document.getElementById("country").value;
  const language = document.getElementById("language").value;
  const bio = document.getElementById("bio").value;
  const email = document.getElementById("email-display").textContent;
  const profilePicUrl = document.getElementById("preview").src || "";

  const profileData = {
    userId,
    fullName,
    username,
    collegeName,
    department,
    semester,
    gender,
    country,
    language,
    bio,
    email,
    profilePicUrl
  };

  try {
    const res = await fetch('/edit-profile', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(profileData)
    });

    const result = await res.json();
    alert(result.message || result.error || "Unknown response");

  } catch (err) {
    alert("Error saving profile: " + err.message);
  }
}
  document.querySelector(".edit-btn").addEventListener("click", async function () {
    if (isEditing) {
      // Save mode
      await saveProfileToServer();
      setReadOnlyState(true);
      this.textContent = "Edit";
    } else {
      // Edit mode
      setReadOnlyState(false);
      this.textContent = "Save";
    }
    isEditing = !isEditing;
  });

  window.onload = () => {
    const name = localStorage.getItem("username") || "Guest";
    const email = localStorage.getItem("email") || "guest@example.com";
    const avatar = email.charAt(0).toUpperCase();

    document.getElementById("profile-name").textContent = name;
    document.getElementById("profile-email").textContent = email;
    document.getElementById("email-display").textContent = email;
    document.getElementById("welcome-message").textContent = `Welcome, ${name}`;
    document.getElementById("sidebar-name").textContent = name;
    document.getElementById("initial-avatar").textContent = avatar;

    setReadOnlyState(false); // Editable by default
    updateWelcomeMessage();
    document.querySelector(".edit-btn").textContent = "Save";
    isEditing = true;
  };
</script>
</body>
</html>